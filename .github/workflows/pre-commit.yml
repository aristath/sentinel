name: Lefthook Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lefthook:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23.2'
        cache-dependency-path: go.sum

    - name: Copy files for embedding
      run: |
        # Copy frontend/dist, display/python, display/app.yaml, and display/sketch into pkg/embedded/ for embedding
        # This allows embed directive to access all files without using .. paths
        # Must be done BEFORE go mod tidy so the embed directive can find the files
        mkdir -p pkg/embedded/frontend pkg/embedded/display
        if [ ! -d "frontend/dist" ]; then
          echo "ERROR: frontend/dist not found - frontend must be built and committed"
          exit 1
        fi
        if [ ! -d "display/python" ]; then
          echo "ERROR: display/python not found"
          exit 1
        fi
        if [ ! -f "display/app.yaml" ]; then
          echo "ERROR: display/app.yaml not found"
          exit 1
        fi
        if [ ! -d "display/sketch" ]; then
          echo "ERROR: display/sketch not found"
          exit 1
        fi
        cp -r frontend/dist pkg/embedded/frontend/
        cp -r display/python pkg/embedded/display/
        cp display/app.yaml pkg/embedded/display/
        cp -r display/sketch pkg/embedded/display/
        echo "✓ Copied files for embedding"

    - name: Install Go tools
      run: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        go install github.com/evilmartians/lefthook@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Verify tools
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        golangci-lint --version
        lefthook version

    - name: Run lefthook checks
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        # Run individual checks instead of full pre-commit hook
        # This avoids issues with git staging in CI environment

        echo "=== Checking Go formatting ==="
        gofmt -l . | tee /tmp/gofmt.out
        if [ -s /tmp/gofmt.out ]; then
          echo "❌ Go files not formatted. Run: gofmt -w ."
          exit 1
        fi
        echo "✓ Go formatting OK"

        echo ""
        echo "=== Running go vet ==="
        go vet ./...
        echo "✓ go vet OK"

        echo ""
        echo "=== Running go mod tidy check ==="
        go mod tidy
        if ! git diff --quiet go.mod go.sum 2>/dev/null; then
          echo "❌ go.mod or go.sum is not tidy. Run: go mod tidy"
          git diff go.mod go.sum
          exit 1
        fi
        echo "✓ go mod tidy OK"

        echo ""
        echo "=== Running go build ==="
        go build ./...
        echo "✓ go build OK"

        echo ""
        echo "=== Running golangci-lint ==="
        golangci-lint run --timeout=5m --config .golangci.yml ./...
        echo "✓ golangci-lint OK"

        echo ""
        echo "=== All checks passed! ==="
